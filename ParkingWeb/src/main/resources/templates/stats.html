<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Thống kê doanh thu</title>
        <link rel="stylesheet" th:href="@{/css/style.css}" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body class="container py-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Thống kê doanh thu theo bãi xe</h2>
            <a class="btn btn-secondary" th:href="@{/}">Về trang chủ</a>
        </div>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Tên bãi xe</th>
                    <th>Tổng doanh thu (VNĐ)</th>
                    <th>Số lượt đặt chỗ</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="row : ${stats}">
                    <td th:text="${row[0]}">Tên bãi</td>
                    <td th:text="${#numbers.formatDecimal(row[1], 0, 'COMMA', 0, 'POINT')}">0</td>
                    <td th:text="${row[2]}">0</td>
                </tr>
            </tbody>
        </table>

        <canvas id="revenueChart" class="my-5"></canvas>

        <hr/>

        <h2>Thống kê theo thời gian</h2>
        <form method="get" th:action="@{/stats}" class="row g-2 mb-3">
            <div class="col-auto">
                <input type="number" name="day" class="form-control" placeholder="Ngày" th:value="${day}" min="1" max="31"/>
            </div>
            <div class="col-auto">
                <input type="number" name="month" class="form-control" placeholder="Tháng" th:value="${month}" min="1" max="12"/>
            </div>
            <div class="col-auto">
                <input type="number" name="year" class="form-control" placeholder="Năm" th:value="${year}" min="2000"/>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Lọc</button>
            </div>
        </form>

        <table class="table table-bordered">
            <thead class="table-secondary">
                <tr>
                    <th>Doanh thu</th>
                    <th>Số lượt đặt</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="row : ${timeStats}">
                    <td th:text="${#numbers.formatDecimal(row[0], 0, 'COMMA', 0, 'POINT')}">Doanh thu</td>
                    <td th:text="${row[1]}">Số lượt đặt</td>
                </tr>
            </tbody>
        </table>
        
        <canvas id="timeStatsChart" class="my-5"></canvas>

        <hr/>

        <h2>Top khách hàng theo doanh thu</h2>
        <table class="table table-bordered table-hover">
            <thead class="table-success">
                <tr>
                    <th>Họ tên khách hàng</th>
                    <th>Tổng doanh thu (VNĐ)</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="row : ${topUsers}">
                    <td th:text="${row[0]}">Tên khách hàng</td>
                    <td th:text="${#numbers.formatDecimal(row[1], 0, 'COMMA', 0, 'POINT')}">0</td>
                </tr>
            </tbody>
        </table>
        <canvas id="topUserChart" class="my-5"></canvas>


        <script th:inline="javascript">
            const chartLabels = [[${stats.stream().map(s - > s[0]).toList()}
            ]];
                    const chartData = [[${stats.stream().map(s - > s[1]).toList()}
                    ]];

            new Chart(document.getElementById("revenueChart"), {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: chartData,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString('vi-VN') + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });

            const timeRevenueData = [[${timeStats.stream().map(r - > r[0]).toList()}
            ]];
                    const timeBookingData = [[${timeStats.stream().map(r - > r[1]).toList()}
                    ]];

            new Chart(document.getElementById("timeStatsChart"), {
                type: 'bar',
                data: {
                    labels: ["Thống kê theo thời gian"], // Chỉ có 1 cột
                    datasets: [
                        {
                            label: 'Doanh thu (VNĐ)',
                            data: timeRevenueData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Số lượt đặt',
                            data: timeBookingData,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const topUserLabels = [[${topUsers.stream().map(u - > u[0]).toList()}
            ]];
                    const topUserData = [[${topUsers.stream().map(u - > u[1]).toList()}
                    ]];

            new Chart(document.getElementById("topUserChart"), {
                type: 'bar',
                data: {
                    labels: topUserLabels,
                    datasets: [{
                            label: 'Tổng doanh thu (VNĐ)',
                            data: topUserData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString('vi-VN') + ' VNĐ';
                                }
                            }
                        }
                    }
                }
            });

        </script>


    </body>
</html>
